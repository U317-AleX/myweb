# ğŸ“š Block Chain

æ­¤èŠ‚ç¬”è®°ä¸»è¦å‚è€ƒäº† PKU è‚–è‡»è€å¸ˆçš„ã€ŠåŒºå—é“¾æŠ€æœ¯ä¸åº”ç”¨ã€‹å…¬å¼€è¯¾ã€‚

è‚–è‡»è€å¸ˆçš„homepageï¼š[http://zhenxiao.com/](http://zhenxiao.com/)

å…¬å¼€è¯¾ç½‘å€ï¼š[https://www.bilibili.com/video/av37065233/](https://www.bilibili.com/video/av37065233/)

---

## ä»€ä¹ˆæ˜¯åŒºå—é“¾ï¼Ÿ

åŒºå—é“¾æ˜¯ä¸€ç§å»ä¸­å¿ƒåŒ–ã€åˆ†å¸ƒå¼ä¸”é€šå¸¸æ˜¯å…¬å…±çš„æ•°å­—åˆ†ç±»è´¦ï¼Œç”±ç§°ä¸ºåŒºå—çš„è®°å½•ç»„æˆï¼Œè¿™äº›åŒºå—ç”¨äºè®°å½•äº¤æ˜“ä¿¡æ¯åˆ°å¤šå°ç”µè„‘ä¸Šï¼Œä»¥ä¾¿ä»»ä½•æ¶‰åŠçš„åŒºå—éƒ½ä¸èƒ½è¢«è¿½æº¯æ›´æ”¹ï¼Œå¦åˆ™ä¼šå½±å“åç»­çš„åŒºå—ã€‚

ä»æ•°æ®ç»“æ„çš„è§’åº¦çœ‹ï¼ŒåŒºå—é“¾æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªåŒºå—è€ŒèŠ‚ç‚¹ä¹‹é—´çš„æŒ‡é’ˆé‡‡ç”¨ hash pointerã€‚

æ¯ä¸ªåŒºå—éƒ½åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼šblock header ä»¥åŠ block bodyã€‚

block header ä¸­ä¸»è¦ç»´æŠ¤äº†æŒ‡å‘ä¸Šä¸€ä¸ªåŒºå—çš„ block header çš„ hash pointerï¼Œä»¥åŠç»„ç»‡æœ¬åŒºå—æ•°æ®çš„å„ç§æ ‘çš„ root pointerã€‚

block body ä¸­ä¸»è¦ä¿å­˜äº†æœ¬åŒºå—çš„å„ç§æ•°æ®ã€‚BTC é“¾çš„ block body ä¿å­˜äº†æœ¬åŒºåŒºå—çš„äº¤æ˜“è®°å½•ï¼Œè€Œ ETH é“¾çš„ block body ä¿å­˜äº†æœ¬åŒºå—çš„ç”¨æˆ·çŠ¶æ€ã€äº¤æ˜“è®°å½•ä»¥åŠæ”¶æ®ã€‚

![ETH chain's block](img/ETH_chain.png)
**ETH chain's block**

åŒºå—é“¾è¿™ä¸ªæ•°æ®ç»“æ„æœ¬èº«è¢«ç»´æŠ¤åœ¨ä¸€ä¸ª P2P çš„ç½‘ç»œä¸­ï¼Œè¯¥ç½‘ç»œæ‹“æ‰‘æœ‰ä¸¤ç±»èŠ‚ç‚¹ï¼šå…¨èŠ‚ç‚¹å’Œè½»èŠ‚ç‚¹ã€‚
æ¯ä¸ªå…¨èŠ‚ç‚¹ä¿å­˜åŒºå—é“¾çš„ä¸€ä¸ªå®Œæ•´å‰¯æœ¬ï¼Œè€Œæ¯ä¸ªè½»èŠ‚ç‚¹åªä¿å­˜åŒºå—é“¾æ‰€æœ‰ block header çš„å‰¯æœ¬ã€‚å½“è½»èŠ‚ç‚¹éœ€è¦ block body çš„ä¿¡æ¯æ˜¯ï¼Œå®ƒä¼šè¯·æ±‚å…¨èŠ‚ç‚¹å‘é€ç›¸åº”ä¿¡æ¯ã€‚

---

## åŒºå—é“¾å¦‚ä½•ä¿è¯ä¸èƒ½è¢«ç¯¡æ”¹ï¼Ÿ
è¿™å¾—ç›Šäº hash pointerã€‚æ‰€è°“çš„ hash pointer åªæ˜¯ä¸€ç§å½¢è±¡çš„è¯´æ³•ï¼Œå®é™…ä¸Š block headeré‡Œåªæœ‰å“ˆå¸Œå€¼ï¼Œæ²¡æœ‰æŒ‡é’ˆã€‚

é‚£ä¹ˆæ€ä¹ˆæ‰èƒ½æ‰¾åˆ°å‰ä¸€ä¸ªåŒºå—çš„å†…å®¹å‘¢ï¼Ÿå…¨èŠ‚ç‚¹ä¸€èˆ¬æ˜¯æŠŠè¿™äº›åŒºå—å­˜å‚¨åœ¨ä¸€ä¸ª (keyï¼Œvalue) æ•°æ®åº“é‡Œé¢ã€‚key æ˜¯åŒºå—çš„å“ˆå¸Œï¼Œvalueå°±æ˜¯åŒºå—çš„å†…å®¹ã€‚ä¸€ä¸ªå¸¸ç”¨çš„ key value æ•°æ®åº“æ˜¯ level DBã€‚æ‰€è°“çš„åŒºå—é“¾è¿™ç§é“¾è¡¨ç»“æ„å®é™…ä¸Šæ˜¯åœ¨ level DB é‡Œé¢ç”¨å“ˆå¸Œå€¼ç®—å‡ºæ¥çš„ã€‚åªè¦ä½ æŒæ¡äº†æœ€åä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼ï¼Œé‚£ä¹ˆä½ é€šè¿‡ level DB çš„æŸ¥æ‰¾ï¼Œå“ˆå¸Œå€¼ key å¯¹åº”çš„ value å°±å¯ä»¥æŠŠæœ€åä¸€ä¸ªåŒºå—çš„å†…å®¹å–å‡ºæ¥ã€‚ç„¶åè¿™ä¸ªåŒºå—å—å¤´é‡Œé¢ï¼Œåˆæœ‰æŒ‡å‘å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼ã€‚é‚£ä¹ˆå†å»æŸ¥æ‰¾ key å’Œ valueï¼Œå¯ä»¥æ‰¾åˆ°å‰ä¸€ä¸ªåŒºå—çš„å†…å®¹ï¼Œä»¥æ­¤ç±»æ¨ï¼Œä¸€æ­¥ä¸€æ­¥å¾€å‰æ‰¾ï¼Œæœ€ç»ˆèƒ½å¤ŸæŠŠæ•´ä¸ªåŒºå—é“¾éƒ½æ‰¾å‡ºæ¥ã€‚

æ‰€ä»¥è¯´åœ¨å®é™…ç³»ç»Ÿå½“ä¸­ï¼Œæ‰€è°“çš„å“ˆå¸ŒæŒ‡é’ˆï¼Œåªæœ‰å“ˆå¸Œï¼Œæ²¡æœ‰æŒ‡é’ˆï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è®¤ä¸ºå“ˆå¸Œå€¼çš„æœ¬èº«å°±æ˜¯æŒ‡é’ˆã€‚

æœ‰ä¸€äº›èŠ‚ç‚¹æ²¡æœ‰ä¿å­˜å®Œæ•´çš„åŒºå—é“¾çš„ä¿¡æ¯ï¼Œåªä¿å­˜äº†æœ€è¿‘çš„å‡ åƒä¸ªåŒºå—ï¼Œå¦‚æœéœ€è¦ç”¨åˆ°å‰é¢çš„åŒºå—çš„ä¿¡æ¯å¯ä»¥é—®å…¶ä»–çš„å…¨èŠ‚ç‚¹è¦ã€‚å“ˆå¸ŒæŒ‡é’ˆçš„æ€§è´¨ä¿è¯äº†æ•´ä¸ªåŒºå—é“¾çš„å†…å®¹æ˜¯ä¸å¯ç¯¡æ”¹çš„ã€‚

åœ¨éªŒè¯çš„æ—¶å€™ï¼Œ**èŠ‚ç‚¹ä¼šé‡æ–°è®¡ç®—å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼**ï¼Œç„¶åæŠŠé‡æ–°ç®—å‡ºæ¥çš„çœŸå®å“ˆå¸Œ hash_actual å’Œå½“å‰åŒºå—é‡Œå£°æ˜çš„ previous_hash å¯¹æ¯”ã€‚

ä½ æ”¹äº†å‰ä¸€ä¸ªåŒºå—ï¼Œä½†åä¸€ä¸ªåŒºå—æ—©å°±è®°ç€åŸæ¥çš„å“ˆå¸Œäº†ï¼Œ
è€ŒéªŒè¯çš„æ—¶å€™ï¼Œ**ç”¨æ–°çš„å‰åŒºå—å†…å®¹é‡æ–°ç®—å“ˆå¸Œ â” æ–°ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼å’ŒååŒºå—å£°æ˜çš„å€¼ä¸ä¸€æ · â” å¯¹ä¸ä¸Šï¼ŒéªŒè¯å¤±è´¥ã€‚**

---

## å…±è¯†æœºåˆ¶
åŒºå—é“¾çš„**å…±è¯†æœºåˆ¶ï¼ˆConsensus Mechanismï¼‰**æ˜¯æŒ‡ç½‘ç»œä¸­æ‰€æœ‰èŠ‚ç‚¹åœ¨æ²¡æœ‰ä¸­å¿ƒåŒ–æ§åˆ¶çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•å°±æŸä¸€æ•°æ®çŠ¶æ€ï¼ˆå¦‚æ–°åŒºå—ï¼‰è¾¾æˆä¸€è‡´çš„åè®®ã€‚å®ƒæ˜¯å»ä¸­å¿ƒåŒ–ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå®ƒèƒ½ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹æœ€ç»ˆæ‹¥æœ‰ä¸€è‡´çš„åŒºå—é“¾å‰¯æœ¬ï¼Œå¹¶ä¸”å‘å¸ƒçš„äº¤æ˜“éƒ½æ˜¯åˆæ³•çš„ã€‚

å…±è¯†æœºåˆ¶ä½¿å¾—åªæœ‰å¯ä»¥æä¾› PoW æˆ–è€… PoS çš„èŠ‚ç‚¹å‘å¸ƒæ–°åŒºå—ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœæ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½éšæ„å‘å¸ƒæ–°åŒºå—ï¼Œé‚£ä¹ˆå‡ºç°äº’æ–¥äº¤æ˜“æ—¶ï¼Œæ•´ä¸ªç³»ç»Ÿä¸çŸ¥é“ä»¥å“ªä¸€ä¸ªä¸ºå‡†ï¼Œå¯èƒ½å¯¼è‡´åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§çš„ä¸¢å¤±ã€‚PoW æˆ–è€… PoS å¯ä»¥æä¾›ä¸€ç§ä»²è£æœºåˆ¶ï¼Œè¡¨ç¤ºä¸€åˆ‡ä»¥**äº«æœ‰æƒç›Šçš„èŠ‚ç‚¹å†™å…¥çš„ä¿¡æ¯ä¸ºå‡†ã€‚**

---


## æŒ–çŸ¿
å¹¶éæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½èƒ½å‘åŒºå—é“¾ä¸Šæ·»åŠ æ–°çš„å—ï¼Œåªæœ‰æä¾›äº† PoW æˆ– PoS ä»¥æ­¤è·å¾—äº†**è®°è´¦æƒ**çš„èŠ‚ç‚¹æœ‰æƒå‘åŒºå—é“¾æ·»åŠ æ–°çš„åŒºå—ã€‚
è€Œè·å¾— PoW ï¼ˆå¾€å¾€ä¼´éšç€ block rewardï¼‰çš„æ–¹æ³•ç§°ä¹‹ä¸ºæŒ–çŸ¿ã€‚

æŒ–çŸ¿çš„é€»è¾‘æ˜¯ï¼Œminer éœ€è¦ä¸æ–­è°ƒæ•´ä¸€ä¸ªå«åš block header ä¸­çš„ nonce çš„å‚æ•°ï¼Œä½¿å¾—ä¸€ä¸ªå¤æ‚çš„ hash function å¯¹ block header ä½œç”¨åçš„è¾“å‡ºå°äºè§„å®šçš„ target å€¼ã€‚ åœ¨ç”³è¯·æäº¤åŒºå—æ—¶ï¼Œminer å°†è¿™ä¸ª nonce å‚æ•°å†™å…¥ block headerï¼Œç»´æŠ¤åŒºå—é“¾çš„èŠ‚ç‚¹ä¼šéªŒè¯è¿™ä¸ª nonce æ˜¯å¦ä½¿å¾— hash function çš„è¾“å‡ºå°äº targetã€‚å¦‚æœç¡®å®å°äº targetï¼Œå‘å¸ƒè¿™ä¸ªåŒºå—ã€‚

ç”±äºå°è¯•çš„ nonce æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥**æŒ–çŸ¿æœ¬èº«æ˜¯æ— è®°å¿†çš„**ã€‚ä¹Ÿå°±æ˜¯è¯´å·²ç»å°è¯•çš„ nonce æ•°é‡ï¼Œå’Œæ‰¾åˆ°ä¸€ä¸ªå°äº target çš„å“ˆå¸Œå€¼çš„æ¦‚ç‡æ— å…³ã€‚

---

## éªŒè¯
éªŒè¯åŒ…æ‹¬å·¥ä½œé‡çš„éªŒè¯ï¼šéªŒè¯ block header çš„å“ˆå¸Œå€¼æ˜¯å¦å°äº targetï¼Œ
ä»¥åŠäº¤æ˜“åˆæ³•æ€§çš„éªŒè¯ï¼šæœ¬åœ°èŠ‚ç‚¹é‡æ–°å¾€ Merkel Tree ä¸Šå†™å…¥ä¸€éå‘å¸ƒçš„äº¤æ˜“ï¼ŒéªŒè¯å¾—åˆ°çš„ root hash æ˜¯å¦ä¸å‘å¸ƒåŒºå—çš„ root hash åŒ¹é…ã€‚

---

## Merkle Proof
Merkle Proof æ˜¯æŒ‡åœ¨åŒºå—é“¾ä¸­ï¼Œè½»èŠ‚ç‚¹ç”¨æ¥éªŒè¯äº¤æ˜“åˆæ³•æ€§çš„è¯æ˜æœºåˆ¶ã€‚å®ƒæ˜¯ SPVï¼ˆSimplified Payment Verificationï¼‰ çš„å®ç°åŸºç¡€ã€‚

äº¤æ˜“è€…å‘ç»´æŠ¤åŒºå—é“¾çš„ç½‘ç»œèŠ‚ç‚¹æäº¤åŒºå—æ—¶éœ€è¦è¯æ˜å°†è¦å†™å…¥åŒºå—çš„äº¤æ˜“åˆæ³•ã€‚åœ¨ BTC ä¸­ï¼Œäº¤æ˜“è€…éœ€è¦æä¾›å¸çš„æ¥æºä¿¡æ¯ï¼Œåœ¨ ETH ä¸­ï¼Œäº¤æ˜“è€…éœ€è¦æä¾›è´¦å·çŠ¶æ€ä¿¡æ¯ï¼ˆè´¦æˆ·ä½™é¢ä¿¡æ¯ï¼‰ï¼›è¿™äº›ä¿¡æ¯æˆ–ä¿å­˜åœ¨ Merkle tree ä¸­ï¼Œæˆ–ä¿å­˜åœ¨ Modified Merkle Patricia Trie ä¸­ã€‚å½“äº¤æ˜“è€…è¦æäº¤ç›¸åº”ä¿¡æ¯çš„èŠ‚ç‚¹æ—¶ï¼Œå®é™…ä¸Šæ˜¯æä¾›äº†ä» root èŠ‚ç‚¹åˆ°ç›¸åº”å¶å­èŠ‚ç‚¹çš„é“¾è·¯ä¸Šçš„æ‰€æœ‰ hash pointerã€‚ç»´æŠ¤åŒºå—é“¾çš„ç½‘ç»œèŠ‚ç‚¹å°†ç»™å®šçš„ hash pointer ä¸åŒèŠ‚ç‚¹ä¸­çš„ hash pointer ç»„åˆï¼Œè‡ªåº•å‘ä¸Šè®¡ç®—å‡ºæœ€ç»ˆçš„å®é™…æ ¹èŠ‚ç‚¹çš„ atul_hash å¹¶å’Œ block header ä¸­ç»´æŠ¤çš„æ ¹èŠ‚ç‚¹ hash å¯¹æ¯”ã€‚è‹¥ä¸¤è€…ç›¸ç­‰ï¼ŒéªŒè¯é€šè¿‡ï¼›åä¹‹ä¸é€šè¿‡ã€‚

ä¸‹é¢çš„å±•ç¤ºçš„æ˜¯ä¸€ä¸ªè½»èŠ‚ç‚¹è¿›è¡Œ Merkle Proof çš„è¿‡ç¨‹ã€‚

![mpt](img/merkle_proof-1.png)
![mpt](img/merkle_proof-2.png)
![mpt](img/merkle_proof-3.png)
![mpt](img/merkle_proof-4.png)
**A Merkle Proof in Light Node**

---

## ETH

### ETH çš„æ•°æ®ç»“æ„
ETH çš„æ•°æ®ç»“æ„ä¸»è¦æœ‰ä¸¤ç§ï¼šBlock Chain ä»¥åŠ Modified Merkle Patricia Trieã€‚

è¿™é‡Œä¸»è¦è®¨è®º Modified Merkle Patricia Trieã€‚ç®€å•åœ°è®²ï¼ŒModified Merkle Patricia Trie æ˜¯æ”¹è‰¯åçš„ Merkle Patricia Trieï¼Œ è€Œ Merkle Patricia Trie å°±æ˜¯ä½¿ç”¨ hash pointer çš„ Radix Treeã€‚

ä¸åŒäº BTC åªåœ¨ block body ä¸­ç»´æŠ¤äº¤æ˜“çš„å†…å®¹ï¼ŒETH æ˜¾å¼åœ°åœ¨ block body ä¸­ç»´æŠ¤è´¦æˆ·çŠ¶æ€ï¼Œäº¤æ˜“ä»¥åŠæ”¶æ®ä¸‰ç§ä¿¡æ¯ã€‚è¿™ä¸‰ç§ä¿¡æ¯è¢«ç»„ç»‡æˆ Merkle Patricia Trieï¼Œå…¶ root pointer è¢«ç»´æŠ¤åœ¨ block header ä¸­ã€‚

![mpt](img/16-ETH-5.png)
**ETH Modified Merkle-Patricia-Trie System**

ETH ä½¿ç”¨ Modified Merkle Patricia Trie ä¸»è¦æ˜¯åŸºäºéœ€è¦ä¿®æ”¹ç”¨æˆ·çŠ¶æ€çš„è€ƒè™‘ã€‚å¦‚æœåƒ BTC ä¸€æ ·ç›´æ¥ä½¿ç”¨ Merkle Treeï¼Œæ¯æ¬¡ä¿®æ”¹ä¸€ä¸ªè´¦æˆ·çŠ¶æ€ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ Merkle Tree å¿…é¡»é‡æ„ï¼Œä½†ä¸åŒçš„èŠ‚ç‚¹å¯èƒ½ä¼šæ„é€ å‡ºä¸åŒçš„ Merkle Treeï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚è¿™ä¼šä¸º Merkle Proof å¸¦æ¥å›°éš¾ã€‚

å®é™…ä¸Šï¼ŒETH å¯¹è´¦æˆ·çš„ä¿®æ”¹å¹¶éåŸåœ°çš„ï¼Œè€Œæ˜¯åœ¨æ–°åŒºå—çš„ Modified Merkle Patricia Trie å†™å…¥æ›´æ–°åçš„åˆ†æ”¯ï¼Œå…¶ä»–æ‰€æœ‰èŠ‚ç‚¹æŒ‡å‘åŸæ¥çš„åœ°å€ã€‚è¿™æ˜¯å› ä¸ºå­˜åœ¨ roll back çš„éœ€æ±‚ï¼Œå¹¶ä¸”è¿™æ ·åšä¸éœ€è¦æŠŠæ•´æ£µæ ‘å‘å¸ƒï¼Œé™ä½äº†ç½‘ç»œè´Ÿæ‹…ã€‚

![ETH chain's block](img/16-ETH-6.png)
**Updating For Modified Merkle Patricia Trie**

ETH åŒºå—å†…çš„äº¤æ˜“è®°å½•ä¸æ”¶æ®åŒæ ·ä¹Ÿè¢«ç»„ç»‡ä¸º Modified Merkle Patricia Trieï¼Œå®ƒä»¬çš„èŠ‚ç‚¹æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚

### Bloom Filter
Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰æ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡æé«˜çš„æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦â€œå¯èƒ½å­˜åœ¨â€äºä¸€ä¸ªé›†åˆä¸­ã€‚å®ƒå¸¸ç”¨äºç½‘ç»œå®‰å…¨ã€åŒºå—é“¾ã€æ•°æ®åº“ã€æœç´¢å¼•æ“ç­‰å¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ã€‚

å®ƒæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š
- èƒ½åˆ¤æ–­å…ƒç´ å¯èƒ½åœ¨é›†åˆä¸­
- ä¸èƒ½åˆ¤æ–­å…ƒç´ ä¸€å®šä¸åœ¨é›†åˆä¸­
- æœ‰ä¸€å®šè¯¯åˆ¤ç‡ï¼ˆå‡é˜³æ€§ false positiveï¼‰
- ä¸ä¼šæœ‰æ¼åˆ¤ï¼ˆfalse negativeï¼‰

Bloom Filter ä½¿ç”¨ï¼Œä¸€ä¸ªä½æ•°ç»„ï¼ˆbit arrayï¼‰ï¼Œåˆå§‹å…¨ä¸º 0 ä»¥åŠ k ä¸ªç‹¬ç«‹å“ˆå¸Œå‡½æ•°ï¼ˆå¦‚æœå…¶ä¸­ä¸€ä¸ª hash function å¯¼è‡´ä¸¤ä¸ªå…ƒç´ çš„å‘ç”Ÿ Hash Collisionï¼Œæˆ‘ä»¬èƒ½æœ‰å¦ä¸€ä¸ª hash function ä½¿å¾—å®ƒä»¬ä¸å‘ç”Ÿç¢°æ’ï¼Œè¿™é™ä½äº† false positive çš„æ¦‚ç‡ï¼‰ã€‚

æ’å…¥å…ƒç´ ï¼š
å°†å…ƒç´ è¾“å…¥åˆ° k ä¸ªå“ˆå¸Œå‡½æ•°ä¸­ï¼Œå¾—åˆ° k ä¸ªä½ç½®ï¼ŒæŠŠä½æ•°ç»„çš„è¿™ k ä¸ªä½ç½®å…¨éƒ¨è®¾ç½®ä¸º 1ã€‚

åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼š
- ç”¨åŒæ ·çš„ k ä¸ªå“ˆå¸Œå‡½æ•°å¤„ç†è¿™ä¸ªå…ƒç´ ï¼Œå¦‚æœæ‰€æœ‰å¯¹åº”çš„ä½éƒ½æ˜¯ 1 â†’ å…ƒç´ å¯èƒ½å­˜åœ¨ï¼ˆä½†å¯èƒ½æ˜¯è¯¯åˆ¤ï¼‰
- å¦‚æœä»»ä½•ä¸€ä½æ˜¯ 0 â†’ å…ƒç´ ä¸€å®šä¸å­˜åœ¨

åœ¨åˆ é™¤ä¸€ä¸ªå…ƒç´ æ—¶ä¹Ÿä¸èƒ½æŠŠå®ƒå¯¹åº”çš„ bits é‡æ–°ç½® 0ï¼š
Bloom Filter çš„æ¯ä¸€ä½å¯èƒ½æ˜¯å¤šä¸ªå…ƒç´ é€šè¿‡å“ˆå¸Œæ˜ å°„åˆ°çš„â€œå…±äº«ä½ç½®â€ï¼Œæ¯”å¦‚å…ƒç´  A å’Œ B éƒ½æŠŠç¬¬ 10 ä½è®¾æˆäº† 1ã€‚å¦‚æœä½ â€œåˆ é™¤â€å…ƒç´  A å¹¶æŠŠç¬¬ 10 ä½é‡ç½®ä¸º 0ï¼Œé‚£å…ƒç´  B çš„å­˜åœ¨ä¿¡æ¯ä¹Ÿä¸€èµ·è¢«æŠ¹æ‰äº†ï¼

åœ¨æ¯”ç‰¹å¸ç­‰åŒºå—é“¾ä¸­ï¼ŒSPVï¼ˆSimplified Payment Verificationï¼‰è½»èŠ‚ç‚¹å¹¶ä¸ä¿å­˜æ•´ä¸ªåŒºå—é“¾ï¼Œåªä¸‹è½½åŒºå—å¤´å’Œç›¸å…³äº¤æ˜“ã€‚è¿™æ—¶ï¼ŒBloom Filter å°±å‘æŒ¥ä½œç”¨ï¼šSPV å®¢æˆ·ç«¯å¯ä»¥åˆ›å»ºä¸€ä¸ª Bloom Filterï¼Œè¡¨ç¤ºâ€œæˆ‘å…³å¿ƒçš„åœ°å€/å…¬é’¥å“ˆå¸Œ/äº¤æ˜“è¾“å‡ºâ€ç­‰ã€‚ç„¶åå°†è¿™ä¸ª Bloom Filter å‘é€ç»™å…¨èŠ‚ç‚¹ã€‚å…¨èŠ‚ç‚¹ä½¿ç”¨è¯¥è¿‡æ»¤å™¨åªå‘é€é‚£äº›å¯èƒ½åŒ¹é…è¯¥è½»èŠ‚ç‚¹å…³å¿ƒçš„äº¤æ˜“ã€‚


### GHOST
åœ¨åŒºå—é“¾ä¸­ï¼ŒGHOST æœºåˆ¶ï¼ˆGreedy Heaviest-Observed Sub-Treeï¼‰æ˜¯ä»¥å¤ªåŠç­‰é“¾é‡‡ç”¨çš„ä¸€ç§æ”¹è¿›çš„åŒºå—é€‰æ‹©æœºåˆ¶ï¼Œæ—¨åœ¨è§£å†³æ¯”ç‰¹å¸åŸæœ‰æœ€é•¿é“¾è§„åˆ™çš„æ•ˆç‡é—®é¢˜ï¼Œæé«˜ç³»ç»Ÿååé‡å’Œå®‰å…¨æ€§ã€‚

åœ¨æ¯”ç‰¹å¸ä¸­ï¼ŒçŸ¿å·¥æ€»æ˜¯é€‰æ‹©â€œæœ€é•¿é“¾â€æ¥ç»§ç»­æŒ–çŸ¿ã€‚ä¸€æ—¦ä¸¤ä¸ªåŒºå—å‡ ä¹åŒæ—¶è¢«æŒ–å‡ºæ¥ï¼Œå°±ä¼šä¸´æ—¶äº§ç”Ÿâ€œåˆ†å‰â€ã€‚æœ€ç»ˆåªæœ‰ä¸€æ¡é“¾ä¼šè¢«è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„ï¼Œå¦ä¸€æ¡é“¾ä¸Šçš„åŒºå—ä¼šæˆä¸ºâ€œå­¤å—â€ï¼ˆorphan blockï¼‰ï¼Œè¢«ä¸¢å¼ƒã€‚è¿™æ ·çš„åšçš„é—®é¢˜æ˜¯æµªè´¹è®¡ç®—èµ„æºï¼Œå¯¼è‡´å¾ˆå¤š miner çš„å·¥ä½œç™½è´¹ã€‚

GHOST æœºåˆ¶çš„æ ¸å¿ƒæ€æƒ³æœ‰ä¸¤ä¸ªï¼šç¬¬ä¸€ï¼Œä¸å…¶åªè€ƒè™‘æœ€é•¿é“¾ï¼Œä¸å¦‚è€ƒè™‘åŒ…å«æ›´å¤šâ€œæœ‰æ•ˆå·¥ä½œâ€çš„é“¾ã€‚åœ¨é€‰æ‹©ä¸»é“¾æ—¶ï¼Œä¸ä»…çœ‹â€œå“ªæ¡é“¾æœ€é•¿â€ï¼Œè€Œæ˜¯é€‰â€œå·¥ä½œé‡æœ€å¤§çš„å­æ ‘â€ã€‚ç¬¬äºŒï¼Œå³ä½¿æŸäº›åŒºå—æœªç›´æ¥åœ¨ä¸»é“¾ä¸Šï¼Œåªè¦å®ƒä»¬æ˜¯è¯šå®äº§ç”Ÿçš„ï¼Œä¹Ÿä¼šå¯¹ä¸»é“¾é€‰æ‹©äº§ç”Ÿå½±å“ã€‚

ä»¥å¤ªåŠåœ¨æ—©æœŸç‰ˆæœ¬ä¸­ï¼ˆEthash å…±è¯†ï¼ŒPoWï¼‰å¼•å…¥äº† GHOST çš„ç®€åŒ–ç‰ˆæœ¬ï¼šå…è®¸è¢«â€œä¸¢å¼ƒâ€çš„åˆ†æ”¯ä¸­çš„åˆæ³•åŒºå—éƒ¨åˆ†è·å¾—å¥–åŠ±ã€‚ä¸€ä¸ªä¸»é“¾åŒºå—å¯ä»¥å¼•ç”¨æœ€å¤š 2 ä¸ªå…¶ä»–é“¾ä¸Šçš„ uncle blocksã€‚miner æŒ–åˆ° uncle block ä¹Ÿèƒ½è·å¾—éƒ¨åˆ† ETH å¥–åŠ±ï¼Œå¹¶ä¸”è¶Šæ—©åœ°è¢«å¼•ç”¨ï¼Œå¾—åˆ°çš„å¥–åŠ±è¶Šå¤šã€‚è¿™ä¸ªæœºåˆ¶èƒ½é¼“åŠ±é‚£äº›æ²¡æœ‰æˆä¸ºä¸»é“¾ç¼–å†™è€…çš„ miner å°½æ—©åˆå¹¶åˆ°ä¸»é“¾ä¸Šï¼Œå‡å°äº† ETH åˆ†å‰çš„é£é™©ã€‚

### ETH çš„æŒ–çŸ¿ç®—æ³•
ä¸ºäº†é˜²æ­¢ ASIC èŠ¯ç‰‡çš„æ»¥ç”¨ï¼ŒETH è®¾è®¡äº† Memory Hard Miner Puzzleï¼ˆASIC miner çš„è®¡ç®—æ€§èƒ½è¿œé«˜äºæ™®é€šä¸ªäººç”µè„‘ï¼Œä½†è®¿å­˜é€Ÿåº¦å´æ²¡æœ‰è¿™ç§ä¼˜åŠ¿ï¼‰ã€‚å…¶ä¸»è¦æ€æƒ³æ˜¯è®© miner åœ¨è¿è¡Œ hash function æ—¶éœ€è¦ç»´æŠ¤ä¸€ä¸ªå¤§çš„æ•°ç»„ï¼Œé€šè¿‡å¤§é‡è®¿å­˜æ—¶é—´æ¥ç¨€é‡Šè®¡ç®—æ—¶é—´ä¸Šçš„ä¼˜åŠ¿ã€‚

è®¡ç®— ETH çš„ hash éœ€è¦ä¸€ä¸ª 16M çš„ cache æ•°ç»„ä»¥åŠä¸€ä¸ª 1G çš„ DAG æ•°ç»„ï¼ˆéœ€è¦çš„ cache å’Œ DAG çš„å¤§å°è¿˜ä¼šéšç€æ—¶é—´å¢é•¿ï¼‰ã€‚

cache é€šè¿‡ cache[0] ä½ç½®ä¸Šçš„ seed å…ƒç´ ä¸æ–­å¾€åè¿›è¡Œ hash function çš„é€’æ¨ç”Ÿæˆã€‚
$$
cache_0 = seed,
$$
$$
cache_n = hash(cache_{n-1})
$$

DAG çš„æ¯ä¸ªä½ç½®ç”±ä¼ªéšæœºæŒ‘é€‰çš„ 256 ä¸ª cache ä¸­çš„å…ƒç´ ç”Ÿæˆã€‚æœ€åï¼Œä» DAG ä¸­æŒ‘é€‰ 128 ä¸ªå…ƒç´ ï¼ˆå’Œ nonce ç›¸å…³ï¼‰ç”Ÿæˆ hash function çš„è¾“å‡ºã€‚

miner æŒ–çŸ¿æ—¶éœ€ç»´æŠ¤ cache å’Œ DAGï¼Œè€Œè¿›è¡ŒéªŒè¯çš„è½»èŠ‚ç‚¹åªéœ€è¦ç»´æŠ¤ cacheï¼ŒåŠ¨æ€ç”Ÿæˆæ‰€éœ€è¦çš„ DAG å…ƒç´ ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ä½¿å¾— miner æœ‰ memory hard çš„åŒæ—¶ï¼Œè½»èŠ‚ç‚¹éªŒè¯ä¸å‡ºç°æ­¤é—®é¢˜ã€‚

### ETH çš„æŒ–çŸ¿éš¾åº¦è°ƒæ•´ç­–ç•¥
ETH è¿›è¡ŒæŒ–çŸ¿éš¾åº¦çš„ä¸»è¦ä½œç”¨æ˜¯ç¨³å®šå‡ºå—é€Ÿåº¦ä»¥åŠç¨³å®šè´§å¸ä¾›ç»™é‡ï¼Œ æŒ–çŸ¿éš¾åº¦ $diff$ ä¸ miner puzzle çš„ $target$ è´Ÿç›¸å…³ã€‚æ¯ä¸ªåŒºå—çš„æŒ–çŸ¿éš¾åº¦åŸºäºä»¥ä¸‹å…¬å¼ï¼š

$$
D(H) \equiv 
\begin{cases}
D_0, & \text{if } H_i = 0 \\
\max\left( D_0, P(H)_{H_d} + x \times \zeta_2 \right) + \epsilon, & \text{otherwise}
\end{cases}
$$

$whereï¼š$

$$
D_0 \equiv 131072
$$

- $H_i$ æ˜¯æœ¬åŒºå—åºå·ã€‚
- $D(H)$ æ˜¯æœ¬åŒºå—çš„éš¾åº¦ï¼Œç”±åŸºç¡€éƒ¨åˆ† $P(H)_{H_d} + x \times \zeta_2$ å’Œéš¾åº¦ç‚¸å¼¹éƒ¨åˆ† $\epsilon$ ç›¸åŠ å¾—åˆ°ã€‚
- $P(H)_{H_d}$ æ˜¯çˆ¶åŒºå—çš„éš¾åº¦ï¼Œæ¯ä¸ªåŒºå—çš„éš¾åº¦éƒ½æ˜¯åœ¨çˆ¶åŒºå—éš¾åº¦çš„åŸºç¡€ä¸Šè¿›è¡Œè°ƒæ•´ã€‚
- $x \times \zeta_2$ ç”¨äºè‡ªé€‚åº”è°ƒèŠ‚å‡ºå—éš¾åº¦ï¼Œç»´æŒç¨³å®šçš„å‡ºå—é€Ÿåº¦ã€‚
- $\epsilon$ è¡¨ç¤ºè®¾å®šçš„éš¾åº¦ç‚¸å¼¹ï¼Œå…¶ä½œç”¨æ˜¯åœ¨ä¸€æ®µæ—¶é—´åä½¿å¾—æŒ–çŸ¿éš¾åº¦çˆ†ç‚¸ï¼Œè¿«ä½¿ PoW å‘ PoS è½¬å‹ã€‚
- åŸºç¡€éƒ¨åˆ†æœ‰ä¸‹ç•Œï¼Œä¸ºæœ€å°å€¼ $D_0 = 131072$ã€‚

è‡ªé€‚åº”éš¾åº¦è°ƒæ•´ $x \times \zeta_2$:

$$
x \equiv \left\lfloor \frac{P(H)_{H_d}}{2048} \right\rfloor
\quad
$$

$$
\zeta_2 \equiv \max\left( y - \left\lfloor \frac{H_s - P(H)_{H_s}}{9} \right\rfloor, -99 \right)
\quad
$$

- $x$ æ˜¯è°ƒæ•´çš„ç²’åº¦ï¼Œ$\zeta_2$ ä¸ºè°ƒæ•´çš„ç³»æ•°ã€‚
- $y$ å’Œçˆ¶åŒºå—çš„ uncle æ•°æœ‰å…³ã€‚å¦‚æœçˆ¶åŒºå—ä¸­åŒ…æ‹¬äº† uncleï¼Œåˆ™ $y$ ä¸º 2ï¼Œå¦åˆ™ä¸º 1ã€‚
- çˆ¶å—åŒ…å« uncle æ—¶ï¼Œéš¾åº¦ä¼šå¤§ä¸€ä¸ªå•ä½ï¼Œå› ä¸ºåŒ…å« uncle æ—¶æ–°å‘è¡Œçš„è´§å¸é‡å¤§ï¼Œéœ€è¦é€‚å½“æé«˜éš¾åº¦ä»¥ä¿æŒè´§å¸å‘è¡Œé‡ç¨³å®šã€‚
- éš¾åº¦é™ä½çš„ä¸Šç•Œè®¾ç½®ä¸º $-99$ï¼Œä¸»è¦æ˜¯åº”å¯¹è¢«é»‘å®¢æ”»å‡»æˆ–å…¶ä»–ç›®å‰æƒ³ä¸åˆ°çš„é»‘å¤©é¹…äº‹ä»¶ã€‚

$$
y - \left\lfloor \frac{H_S - P(H)_{H_S}}{9} \right\rfloor
$$

- $H_S$ æ˜¯æœ¬åŒºå—çš„æ—¶é—´æˆ³ï¼Œ$P(H)_{H_S}$ æ˜¯çˆ¶åŒºå—çš„æ—¶é—´æˆ³ï¼Œå‡ä»¥ç§’ä¸ºå•ä½ï¼Œå¹¶è§„å®š $H_S > P(H)_{H_S}$ ã€‚$H_S - P(H)_{H_S}$ å°±æ˜¯å‡ºå—æ—¶é—´ã€‚
  - è¯¥éƒ¨åˆ†æ˜¯ç¨³å®šå‡ºå—é€Ÿåº¦çš„æœ€é‡è¦éƒ¨åˆ†ï¼šå‡ºå—æ—¶é—´è¿‡çŸ­åˆ™è°ƒå¤§éš¾åº¦ï¼Œå‡ºå—æ—¶é—´è¿‡é•¿åˆ™è°ƒå°éš¾åº¦ã€‚

- ä»¥çˆ¶å—ä¸å¸¦ uncle çš„æƒ…å†µï¼ˆ$y=1$ï¼‰ä¸ºä¾‹ï¼š
  - å‡ºå—æ—¶é—´åœ¨ $[1,8]$ ä¹‹é—´ï¼Œå‡ºå—æ—¶é—´è¿‡çŸ­ï¼Œéš¾åº¦è°ƒå¤§ä¸€ä¸ªå•ä½ã€‚
  - å‡ºå—æ—¶é—´åœ¨ $[9,17]$ ä¹‹é—´ï¼Œå‡ºå—æ—¶é—´å¯ä»¥æ¥å—ï¼Œéš¾åº¦ä¿æŒä¸å˜ã€‚
  - ç›¸å·®æ—¶é—´åœ¨ $[18,26]$ ä¹‹é—´ï¼Œå‡ºå—æ—¶é—´è¿‡é•¿ï¼Œéš¾åº¦è°ƒå°ä¸€ä¸ªå•ä½ã€‚

éš¾åº¦ç‚¸å¼¹ $\epsilon$:

$$\epsilon \equiv \left\lfloor 2^{\left\lfloor \frac{H_i'}{100000} \right\rfloor - 2} \right\rfloor $$

$$H_i' \equiv \max(H_i - 3,000,000)$$

- æ¯åä¸‡ä¸ªåŒºå—æ‰©å¤§ä¸€å€ï¼Œæ˜¯ 2 çš„æŒ‡æ•°å‡½æ•°ï¼ŒåæœŸå¢é•¿æå¿«ï¼Œå› æ­¤è¢«ç§°ä¸ºéš¾åº¦"ç‚¸å¼¹"ã€‚
- é™ä½è¿ç§»åˆ° PoS åè®®æ—¶çš„åˆ†å‰é£é™©ï¼šå½“æŒ–çŸ¿éš¾åº¦æ¿€å¢æ—¶ï¼ŒçŸ¿å·¥æœ‰åŠ¨åŠ›è¿ç§»è‡³ PoS åè®®ã€‚
- ç”±çœŸå®åŒºå—å· $H_i$ å‡å» $300$ ä¸‡å¾—åˆ°ï¼ˆå³ $H_i' = \max(H_i - 3,000,000)$ï¼‰ã€‚  
- æ­¤è®¾è®¡æºäºä½ä¼° PoS åè®®çš„å¼€å‘éš¾åº¦ï¼Œéœ€å»¶é•¿çº¦ä¸€å¹´åŠçš„è¿‡æ¸¡æœŸï¼ˆé€šè¿‡ [EIP-100](https://eips.ethereum.org/EIPS/eip-100) å®ç°ï¼‰ã€‚

### PoS
PoS æ˜¯ Proof-of-Stake çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§åŸºäºç”¨æˆ·æŒæœ‰çš„ä»£å¸æ•°é‡æ¥è¿›è¡Œè®°è´¦æƒåˆ†é…çš„å…±è¯†æœºåˆ¶ã€‚åŸºäº PoW è·å¾—è®°è´¦æƒå¹¿å—è¯Ÿç—…çš„ä¸€ç‚¹æ˜¯ï¼Œéœ€è¦å¤§é‡çš„ç®—åŠ›å’Œèƒ½æºï¼Œè€Œè¿™ä¸¤è€…æ ¹æœ¬ä¸Šæ˜¯ç”±èµ„é‡‘å¤§å°å†³å®šçš„ã€‚å› æ­¤ï¼ŒPoS çš„ä¸€ä¸ªæ ¸å¿ƒæƒ³æ³•æ˜¯**ç›´æ¥é€šè¿‡èµ„æœ¬é‡‘å¤§å°åˆ†é…è®°è´¦æƒ**ã€‚

è€Œ PoS åˆ™æ˜¯åŸºäºç”¨æˆ·æŒæœ‰çš„ä»£å¸æ•°é‡æ¥è¿›è¡Œè®°è´¦æƒåˆ†é…ï¼Œç”¨æˆ·æŒæœ‰çš„ä»£å¸æ•°é‡è¶Šå¤šï¼Œè·å¾—è®°è´¦æƒçš„æ¦‚ç‡å°±è¶Šå¤§ã€‚

è¿™æ ·åšçš„ç¬¬ä¸€ä¸ªå¥½å¤„æ˜¯é™ä½äº†èƒ½æºæ¶ˆè€—ï¼Œå› ä¸ºä¸éœ€è¦å¤§é‡çš„èƒ½æºæ¥ç»´æŒæŒ–çŸ¿çš„è¿‡ç¨‹ã€‚åŒæ—¶ï¼Œç”±äºå¿…é¡»æŒæœ‰ä»£å¸æ‰èƒ½è·å¾—è®°è´¦æƒï¼Œè¿™ä½¿å¾—åœ¨å¸ç§å‘è¡Œæ—©æœŸè®°è´¦æƒè¢«å¼€å‘å›¢é˜Ÿæ§åˆ¶ï¼Œä¹Ÿé¿å…äº† Altcoin Infanticideã€‚

ETH å‡†å¤‡é‡‡ç”¨çš„ PoS åè®®æ˜¯ Casperï¼Œå®ƒå’Œ PoW æ··åˆä½¿ç”¨ï¼Œä¸ºç»è¿‡ PoW éªŒè¯çš„åŒºå—æä¾›è®° finalityã€‚è·å¾— finality çŠ¶æ€çš„åŒºå—ä¼šæˆä¸ºåˆæ³•é“¾çš„éƒ¨åˆ†ï¼Œå³ä½¿æœ‰æ¶æ„æ”»å‡»ä½¿å¾—ä¸ä¹‹å¹³è¡Œçš„æ›´é•¿åˆ†æ”¯å‡ºç°ã€‚

åœ¨ Casper åè®®ä¸­å¼•å…¥äº† Validator çš„æ¦‚å¿µï¼ŒValidator æ˜¯æŒ‡ä¸€äº›ç‰¹æ®Šçš„è´¦æˆ·ï¼Œå®ƒä»¬å¯ä»¥è¡Œä½¿æŠ•ç¥¨æƒä½¿å¾—ä¸€ä¸ª epoch è·å¾— finality çŠ¶æ€ã€‚åœ¨ Casper ä¸­ï¼ŒåŒä¸€åˆ†æ”¯ä¸Šçš„ 50 ä¸ªè¿ç»­åŒºå—ç»„æˆä¸€ä¸ª epochï¼Œæ¯ä¸€è½®æŠ•ç¥¨ä½œç”¨äºåŒä¸€åˆ†æ”¯ä¸Šçš„ä¸¤ä¸ªè¿ç»­çš„ epochã€‚æ¯æ¬¡æŠ•ç¥¨éœ€è¦ 2/3 çš„ Validator åŒæ„æ‰èƒ½é€šè¿‡ï¼›é€šè¿‡åï¼Œå‰ä¸€ä¸ª epoch è·å¾— commit messageï¼Œåä¸€ä¸ª epoch è·å¾— prepare messageï¼›åªæœ‰è·å¾— commit message çš„ epoch æ‰èƒ½è·å¾— finalityã€‚

çº¦æŸ Validator çš„è¡Œä¸ºåˆ©ç”¨äº† Validator Reward å’Œä¿è¯é‡‘åˆ¶åº¦ã€‚å½“ Validator è¡Œä¸ºè‰¯å¥½æ—¶ä¼šå¾—åˆ° Rewardï¼Œåä¹‹åˆ™é”€æ¯ä¸€éƒ¨åˆ†çš„ä¿è¯é‡‘ã€‚è®¾è®¡ä¸Šæ²¡æœ‰ç¡¬æ€§é™åˆ¶ Validator ä¸å¯ä»¥ä¸ºå¤šä¸ªå¹³è¡Œåˆ†æ”¯æŠ•ç¥¨ï¼Œä½†æ˜¯ä¸€æ—¦è¢«å‘ç°å…¶ä¿è¯é‡‘ä¼šè¢«æ²¡æ”¶ã€‚

ç›®å‰ PoS åè®®è¿˜æœ‰è®¸å¤šéœ€è¦è§£å†³çš„é—®é¢˜ï¼ŒPoW ä»ç„¶æ˜¯ä¸»æµã€‚

### æ™ºèƒ½åˆçº¦
æ™ºèƒ½åˆçº¦æ˜¯ä¿å­˜åœ¨åŒºå—é“¾ä¸­çš„ä»£ç ï¼Œå®ƒå®šä¹‰äº†ä¸¤ä¸ªæˆ–è€…æˆ–è€…åŒºå—é“¾è´¦æˆ·çš„äº¤æ˜“è¡Œä¸ºï¼ˆå¦‚å®šä¹‰ä¸€ä¸ªæ‹å–ï¼‰ã€‚åŒºå—é“¾ä¸Šçš„è´¦æˆ·åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç±»æ˜¯**å¤–éƒ¨è´¦æˆ·**ï¼Œå¦ä¸€ç±»æ˜¯**åˆçº¦è´¦æˆ·**ã€‚åˆçº¦ç”¨æˆ·å¯ä»¥çœ‹ä½œä¸€ä¸ªä¸ºå¤–éƒ¨ç”¨æˆ·çš„äº¤æ˜“æœåŠ¡çš„å…¬æ­£ç¬¬ä¸‰æ–¹ï¼›ä¾‹å¦‚ï¼Œä¸€ä¸ªå®šä¹‰äº†æ‹å–çš„åˆçº¦ï¼Œå…¶åˆçº¦è´¦æˆ·å¯ä»¥çœ‹ä½œæ‹å–è¡Œï¼šå¯¹å—ç›Šäººæ¥è¯´ï¼Œå®ƒæ˜¯ç«æ‹è€…çš„ä»£ç†ï¼›å¯¹ç«æ‹è€…æ¥è¯´ï¼Œå®ƒæ˜¯å—ç›Šäººçš„ä»£ç†ã€‚åœ¨ ETH çš„é“¾ä¸Šï¼Œæ™ºèƒ½åˆçº¦ç”¨ Solidity è¯­è¨€ç¼–å†™ã€‚å¯¹äºåŒä¸€è¾“å…¥ï¼Œæ™ºèƒ½åˆçº¦ä¸­çš„æ–¹æ³•è¾“å‡ºå¿…é¡»æ˜¯ä¸å˜çš„ï¼Œæ•…è€Œ**æ™ºèƒ½åˆçº¦ä¸æ”¯æŒå¹¶å‘/å¹¶è¡Œè®¡ç®—**ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆçº¦çš„ä¾‹å­ï¼š
```solidity
pragma solidity ^0.4.21;

contract SimpleAuction {
    address public beneficiary; // æ‹å–å—ç›Šäºº
    uint public auctionEnd;     // ç»“æŸæ—¶é—´

    address public highestBidder; // å½“å‰çš„æœ€é«˜å‡ºä»·äºº
    mapping(address => uint) bids; // æ‰€æœ‰ç«æ‹è€…çš„å‡ºä»·
    address[] bidders;             // æ‰€æœ‰ç«æ‹è€…

    /// éœ€è¦è®°å½•çš„äº‹ä»¶
    event HighestBidIncreased(address bidder, uint amount);
    event Pay2Beneficiary(address winner, uint amount);

    /// ä»¥å—ç›Šè€…åœ°å€ `_beneficiary` çš„åä¹‰ï¼Œ
    /// åˆ›å»ºä¸€ä¸ªç®€å•çš„æ‹å–ï¼Œæ‹å–æ—¶é—´ä¸º `_biddingTime` ç§’ã€‚
    constructor(uint _biddingTime, address _beneficiary) public {
        beneficiary = _beneficiary;
        auctionEnd = now + _biddingTime;
    }

    /// å¯¹æ‹å–è¿›è¡Œå‡ºä»·ï¼Œéšäº¤æ˜“ä¸€èµ·å‘é€çš„etherä¸ä¹‹å‰å·²ç»å‘é€çš„
    /// etherçš„å’Œä¸ºæœ¬æ¬¡å‡ºä»·ã€‚
    function bid() public payable {
        ...
    }

    /// ä½¿ç”¨withdrawæ¨¡å¼
    /// ç”±æŠ•æ ‡è€…è‡ªå·±å–å›å‡ºä»·ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ
    function withdraw() public returns (bool) {
        ...
    }

    /// ç»“æŸæ‹å–ï¼ŒæŠŠæœ€é«˜çš„å‡ºä»·å‘é€ç»™å—ç›Šäºº
    function pay2Beneficiary() public returns (bool) {
        ...
    }
}
```
ä¸€ä¸ªç”¨æˆ·è‹¥å‘å‡ºä»·ï¼Œå¿…é¡»é€šè¿‡ä»–çš„å¤–éƒ¨è´¦æˆ·è°ƒç”¨åˆçº¦ä¸­çš„ `bid()` æ–¹æ³•ã€‚è°ƒç”¨æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªäº¤æ˜“ï¼Œæ¥æ”¶åœ°å€ä¸ºè¦è°ƒç”¨çš„é‚£ä¸ªæ™ºèƒ½åˆçº¦çš„åœ°å€ï¼Œdata åŸŸå¡«å†™è¦è°ƒç”¨çš„å‡½æ•°ä»¥åŠå…¶å‚æ•°çš„ç¼–ç å€¼ã€‚

åˆçº¦è´¦æˆ·ä¹‹é—´ä¹Ÿå¯ä»¥ç›¸äº’è°ƒç”¨ï¼Œæœ‰ç›´æ¥è°ƒç”¨ï¼Œè°ƒç”¨ `address.call()`, ä»£ç†è°ƒç”¨ `delegatecall()` ä¸‰ç§æ–¹æ³•ã€‚ 

1. ç›´æ¥è°ƒç”¨ï¼š
```solidity
contract A {
    event LogCallFoo(string str);

    function foo(string str) returns (uint) {
        emit LogCallFoo(str);
        return 123;
    }
}

contract B {
    uint ua;

    function callAFooDirectly(address addr) public {
        A a = A(addr);
        ua = a.foo("call foo directly");
    }
}
```

- å¦‚æœåœ¨æ‰§è¡Œ `a.foo()` è¿‡ç¨‹ä¸­æŠ›å‡ºé”™è¯¯ï¼Œåˆ™ `callAFooDirectly()` ä¹ŸæŠ›å‡ºé”™è¯¯ï¼Œæœ¬æ¬¡è°ƒç”¨å…¨éƒ¨å›æ»šã€‚
- `ua` ä¸ºæ‰§è¡Œ `a.foo("call foo directly")` çš„è¿”å›å€¼ã€‚
- å¯ä»¥é€šè¿‡ `.gas()` å’Œ `.value()` è°ƒæ•´æä¾›çš„ gas æ•°é‡æˆ–æä¾›ä¸€äº› ETHã€‚

2.è°ƒç”¨ `address.call()`ï¼š

```solidity
contract C {
    function callAfooByCall(address addr) public returns (bool) {
        bytes4 funcsig = bytes4(keccak256("foo(string"));
        if (addr.call(funcsig, "call foo by func call"))
            return true;
        return false;
    }
}
```

- ç¬¬ä¸€ä¸ªå‚æ•°è¢«ç¼–ç æˆ4ä¸ªå­—èŠ‚ï¼Œè¡¨ç¤ºè¦è°ƒç”¨çš„å‡½æ•°çš„ç­¾åã€‚  
- å…¶å®ƒå‚æ•°ä¼šè¢«æ‰©å±•åˆ°32å­—èŠ‚ï¼Œè¡¨ç¤ºè¦è°ƒç”¨å‡½æ•°çš„å‚æ•°ã€‚  
- ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ç›¸å½“äº `A(addr).foo("call foo by func call")`ã€‚  
- è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨æ˜è¢«è°ƒç”¨çš„å‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•ï¼ˆ`true`ï¼‰æˆ–è€…å¼•å‘äº†ä¸€ä¸ªEVMå¼‚å¸¸ï¼ˆ`false`ï¼‰ï¼Œæ— æ³•è·å–å‡½æ•°è¿”å›å€¼ã€‚  
- ä¹Ÿå¯ä»¥é€šè¿‡ `.gas()` å’Œ `.value()` è°ƒæ•´æä¾›çš„ gas æ•°é‡æˆ–æä¾›ä¸€äº› ETHã€‚


3.ä»£ç†è°ƒç”¨ `delegatecall()`ï¼š

- ä½¿ç”¨æ–¹æ³•ä¸ `call()` ç›¸åŒï¼Œåªæ˜¯**ä¸èƒ½ä½¿ç”¨ `.value()`**ã€‚  
- **åŒºåˆ«åœ¨äºæ˜¯å¦åˆ‡æ¢ä¸Šä¸‹æ–‡**ï¼š  
  - `call()` åˆ‡æ¢åˆ°è¢«è°ƒç”¨çš„æ™ºèƒ½åˆçº¦ä¸Šä¸‹æ–‡ä¸­ï¼ˆåŒ…æ‹¬å­˜å‚¨ã€ä½™é¢ç­‰å±æ€§ï¼‰ã€‚  
  - `delegatecall()` åªä½¿ç”¨ç»™å®šåœ°å€çš„**ä»£ç **ï¼Œå…¶ä»–å±æ€§ï¼ˆå­˜å‚¨ã€ä½™é¢ç­‰ï¼‰å‡å–è‡ªå½“å‰åˆçº¦ã€‚  
  - ç›®çš„æ˜¯å¤ç”¨å…¶ä»–åˆçº¦çš„åº“ä»£ç ï¼Œä¾‹å¦‚ï¼šé€šè¿‡ `delegatecall` è°ƒç”¨åº“åˆçº¦ä¸­çš„å‡½æ•°ï¼Œä½†æ“ä½œå½“å‰åˆçº¦çš„å­˜å‚¨çŠ¶æ€ã€‚

å®šä¹‰æ™ºèƒ½åˆçº¦æ—¶ï¼Œæœ‰ä¸€ç±»ç‰¹æ®Šçš„å‡½æ•° `fallback()`ã€‚

```solidity
function() public [payable] {
    ......
}

```
è¿™æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œæ²¡æœ‰å‚æ•°ä¹Ÿæ²¡æœ‰è¿”å›å€¼ã€‚åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä¼šè¢«è°ƒç”¨ï¼š
- ç›´æ¥å‘åˆçº¦åœ°å€è½¬è´¦ä¸”ä¸åŒ…å«ä»»ä½•dataã€‚
- è°ƒç”¨çš„å‡½æ•°åœ¨åˆçº¦ä¸­ä¸å­˜åœ¨ã€‚

å¦‚æœè½¬è´¦é‡‘é¢ä¸ä¸ºé›¶ï¼Œå¿…é¡»å£°æ˜ä¸º payableï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

æ¥å—è½¬è´¦çš„åˆçº¦å¦‚æœæ²¡æœ‰å®šä¹‰ `fallback()` å‡½æ•°ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è¿™ä¸€ç‚¹å¯ä»¥è¢«é»‘å®¢åˆ©ç”¨ï¼Œé€ æˆ**ç¾éš¾æ€§çš„åæœ**ï¼Œæˆ‘ä»¬ä¸‹é¢å¯ä»¥çœ‹åˆ°ã€‚
  
åˆ›å»ºä¸€ä¸ªæ™ºèƒ½åˆçº¦éœ€è¦å¤–éƒ¨è´¦æˆ·å‘èµ·ä¸€ä¸ªè½¬è´¦äº¤æ˜“åˆ° `0x0` åœ°å€, è½¬è´¦é‡‘é¢ä¸º `0`ï¼Œä½†éœ€æ”¯ä»˜æ±½æ²¹è´¹ï¼ˆgasï¼‰ï¼Œåˆçº¦ä»£ç å­˜æ”¾åœ¨äº¤æ˜“çš„ `data` åŸŸä¸­ã€‚

æ™ºèƒ½åˆçº¦è¿è¡Œåœ¨ EVMï¼ˆEthereum Virtual Machineï¼‰ä¸Šã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯æ™ºèƒ½åˆçº¦å¯ä»¥è·¨å¹³å°è¿è¡Œã€‚

### gas fee
æ‰§è¡Œåˆçº¦ä¸­çš„æ¯æ¡æŒ‡ä»¤å‡éœ€æ”¯ä»˜æ±½æ²¹è´¹ï¼Œè´¹ç”¨ç”±äº¤æ˜“å‘èµ·è€…æ‰¿æ‹…ã€‚gas fee çš„è·ç›Šäººæ˜¯å°†è¿™ä¸ªåŒºå—æŒ–å‡ºçš„ minerï¼ˆåªæœ‰è¿™ä¸€ä¸ª miner å¯ä»¥è·å¾—æ±½æ²¹è´¹ï¼‰ï¼Œå› ä¸ºæ‰§è¡Œè¿™äº›æŒ‡ä»¤æ¶ˆè€—çš„æ˜¯è¿™ä¸ª miner æ‹¥æœ‰çš„ç®—åŠ›ã€‚

äº¤æ˜“æ•°æ®ç»“æ„ï¼ˆtxdata structï¼‰ï¼š
```go
type txdata struct {
    AccountNonce uint64          `json:"nonce"     gencodec:"required"`  
    Price        *big.Int        `json:"gasPrice"  gencodec:"required"`  
    GasLimit     uint64          `json:"gas"       gencodec:"required"`  
    Recipient    *common.Address `json:"to"        rlp:"nil"`  // nilè¡¨ç¤ºåˆçº¦åˆ›å»º  
    Amount       *big.Int        `json:"value"     gencodec:"required"`  
    Payload      []byte          `json:"input"     gencodec:"required"`  
}
```
EVMä¸­ä¸åŒæŒ‡ä»¤çš„æ±½æ²¹è´¹æ¶ˆè€—å·®å¼‚ï¼š

- ç®€å•æŒ‡ä»¤ï¼ˆå¦‚ç®—æœ¯è¿ç®—ï¼‰æ¶ˆè€—æ±½æ²¹è´¹è¾ƒä½ã€‚
- å¤æ‚æŒ‡ä»¤ï¼ˆå¦‚å­˜å‚¨çŠ¶æ€ä¿®æ”¹ï¼‰æ¶ˆè€—æ±½æ²¹è´¹è¾ƒé«˜ã€‚
- è®¾è®¡åˆçº¦æ—¶éœ€ä¼˜åŒ–ä»£ç ï¼Œé¿å…é«˜æˆæœ¬æ“ä½œä»¥é™ä½æ±½æ²¹è´¹å¼€é”€ã€‚

**è®¾è®¡ gas fee æ˜¯ä¸ºäº†é˜²æ­¢æ¶æ„è°ƒç”¨åˆçº¦ä¸­çš„æ–¹æ³•ï¼Œæµªè´¹è®¡ç®—èµ„æºã€‚**gas fee ç­–ç•¥çš„å¤±è´¥å¯¼è‡´äº† ETH ç»´æŠ¤å›¢é˜Ÿåœ¨ The DAO äº‹ä»¶ä¸­çš„è½¯åˆ†å‰ç­–ç•¥å¤±æ•ˆï¼Œæˆ‘ä»¬ä¹‹åå°†ä¼šçœ‹åˆ°ã€‚

æ™ºèƒ½åˆçº¦ä¸­ä¸å­˜åœ¨è‡ªå®šä¹‰çš„ try-catch ç»“æ„ï¼Œä¸€æ—¦é‡åˆ°æœªæ•è·çš„å¼‚å¸¸ï¼Œæœ¬æ¬¡æ‰€æœ‰æ“ä½œå°†å®Œå…¨å›æ»šï¼ˆé™¤éä½¿ç”¨ call ç­‰ä½çº§å‡½æ•°ï¼‰ã€‚

é”™è¯¯æŠ›å‡ºæ–¹å¼ï¼š`assert(bool condition)`ï¼Œç”¨äºæ£€æµ‹å†…éƒ¨é”™è¯¯ï¼ˆä¾‹å¦‚ä¸å˜é‡è¿åï¼‰ï¼›`require(bool condition, string message)`ç”¨äºéªŒè¯è¾“å…¥æˆ–å¤–éƒ¨æ¡ä»¶ï¼ˆå¦‚å‡½æ•°å‰ç½®æ¡ä»¶ï¼›`revert(string message)`ï¼Œç›´æ¥ç»ˆæ­¢æ‰§è¡Œå¹¶å›æ»šçŠ¶æ€ï¼Œå¯è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯ã€‚

åµŒå¥—è°ƒç”¨çš„å›æ»šï¼Œå¦‚åˆçº¦ A è°ƒç”¨åˆçº¦ B çš„å‡½æ•°ï¼ˆå¦‚é€šè¿‡ call/delegatecallï¼‰ï¼š

- è‹¥ä½¿ç”¨é«˜å±‚çº§è°ƒç”¨ï¼ˆå¦‚ç›´æ¥è°ƒç”¨ B.foo()ï¼‰ï¼Œè¢«è°ƒç”¨åˆçº¦ B çš„å¼‚å¸¸ä¼šè§¦å‘åˆçº¦ A çš„å®Œå…¨å›æ»šã€‚

- è‹¥ä½¿ç”¨åº•å±‚è°ƒç”¨ï¼ˆå¦‚ B.call(abi.encodeWithSignature("foo()"))ï¼‰ï¼Œå¼‚å¸¸ä»…è¿”å› falseï¼Œåˆçº¦ A çš„çŠ¶æ€ä¿®æ”¹å¯èƒ½ä¿ç•™ã€‚

ä¸€ä¸ªåˆçº¦ç›´æ¥å‘ä¸€ä¸ªåˆçº¦å¸æˆ·é‡Œè½¬è´¦ï¼Œæ²¡æœ‰æŒ‡æ˜è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œä»ç„¶ä¼šå¼•èµ·åµŒå¥—è°ƒç”¨ï¼ˆ`fallback()`å‡½æ•°ï¼‰ã€‚

æ™ºèƒ½åˆçº¦è¿è¡Œåœ¨åŒºå—ç¯å¢ƒä¸­ï¼Œå®ƒåªèƒ½è·å¾—åŒºå—æä¾›çš„ç¯å¢ƒå˜é‡ã€‚

### å…ˆæ‰§è¡Œäº¤æ˜“è¿˜æ˜¯å…ˆæŒ–çŸ¿ï¼Ÿ
æŒ–çŸ¿éœ€è¦å½“å‰ block header çš„ä¿¡æ¯ï¼Œè¿™å…¶ä¸­åŒ…æ‹¬ ETH çš„ block ä¸­ç»´æŠ¤çš„çŠ¶æ€æ ‘ã€äº¤æ˜“æ ‘å’Œæ”¶æ®æ ‘çš„æ ¹èŠ‚ç‚¹ hashã€‚è¿™äº›æ ¹èŠ‚ç‚¹ hash éœ€è¦å…ˆæ‰§è¡Œå½“å‰åŒºå—ä¸­çš„äº¤æ˜“ï¼Œæ‰èƒ½å¤Ÿå¾—åˆ°ã€‚æ‰€ä»¥æ˜¯å…ˆäº¤æ˜“ï¼Œå†æŒ–çŸ¿ã€‚

æœ‰äººå¯èƒ½ä¼šè¯´è¿™æ ·å¯èƒ½ä¼šå¯¼è‡´äº’æ–¥çš„äº¤æ˜“åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯**åªæœ‰å‘å¸ƒçš„åŒºå—ä¸Šçš„äº¤æ˜“æ‰æ˜¯è¢«è®¤å¯çš„å…±è¯†**ã€‚å½“å¦ä¸€ä¸ªèŠ‚ç‚¹å‘å¸ƒä¸æœ¬åœ°èŠ‚ç‚¹çš„äº¤æ˜“æ—¶ï¼Œæœ¬åœ°èŠ‚ç‚¹æŠ›å¼ƒæ­£åœ¨æŒ–çŸ¿çš„è¿™ä¸ªåŒºå—ã€‚

### è°ƒç”¨å¤±è´¥è¿˜è¦å†™å…¥åŒºå—é“¾å—ï¼Ÿ
ä¼šã€‚è‹¥åœ¨è°ƒç”¨è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œæœ¬æ¬¡è°ƒç”¨ä¼š roll back ã€‚ä½† gas fee æ˜¯ä¸€å®šè¦äº¤çš„ï¼Œè‡³å°‘è¦åœ¨åŒºå—é‡Œé¢å†™å…¥ gas fee çš„ä¿¡æ¯ã€‚

### å¦‚ä½•ä¿è¯æ‰€æœ‰èŠ‚ç‚¹éƒ½æ„¿æ„åœ¨æœ¬åœ°éªŒè¯å‘å¸ƒçš„åŒºå—æ˜¯å¦æœ‰æ•ˆï¼Ÿ
åœ¨å…¶ä»–èŠ‚ç‚¹å‘å¸ƒä¸€ä¸ªæ–°åŒºå—æ—¶ï¼Œæœ¬åœ°èŠ‚ç‚¹éªŒè¯æ–°åŒºå—çš„å·¥ä½œé‡æ˜¯éœ€è¦è®¡ç®—èµ„æºçš„ã€‚è€Œä¸”æ‹¥æœ‰æœ¬åœ°èŠ‚ç‚¹çš„ miner ä¹Ÿå¾—ä¸åˆ°éªŒè¯çš„ gas feeã€‚ä¸ºä»€ä¹ˆä»–ä»¬è¿˜æ˜¯æ„¿æ„éªŒè¯è¿™äº›äº¤æ˜“è€Œä¸æ˜¯ç›´æ¥å†™å…¥æœ¬åœ°åŒºå—é“¾å‘¢ï¼Ÿ

è¿™å’Œ root hash çš„éªŒè¯æœ‰å…³ç³»ã€‚å‡è®¾è¿™ä¸ª miner ä¸éªŒè¯å°±ç›´æ¥æŠŠè¿™ä¸ªåŒºå—æ·»åŠ åˆ°åŒºå—é“¾ä¸Šï¼Œå¦‚æœè¿™ä¸ªåŒºå—ä¸­çš„äº¤æ˜“çš„ä¸åˆæ³•çš„ï¼Œé‚£ä¹ˆè¿™ä¸ª miner æ‰€æ‹¥æœ‰èŠ‚ç‚¹ä¸Šè®°å½•çš„ä¸‰é¢— Merkel Tree çš„ root hash å°±å’Œå…¶ä»–è€å®éªŒè¯ miner æ‰€æ‹¥æœ‰çš„èŠ‚ç‚¹ä¸Šè®°å½•çš„ root hash åˆ†é“æ‰¬é•³äº†ã€‚å¦‚æœä¸å‡ºæ„å¤–ï¼Œ**é‚£ä¹ˆè¿™ä¸ªä¸è€å®çš„ miner æ‰€å‘å¸ƒçš„åŒºå—å°±æ°¸è¿œé€šä¸è¿‡éªŒè¯äº†ï¼** 

### Code is Law!!!
å†™å…¥åŒºå—é“¾çš„æ™ºèƒ½åˆçº¦ä¸å¯ä¿®æ”¹ï¼Œå³ä½¿è¿™ä¸ªæ™ºèƒ½åˆçº¦å­˜åœ¨éªŒè¯é€»è¾‘æ¼æ´ã€‚æ‰€ä»¥åœ¨å†™å…¥åŒºå—é“¾å‰ï¼Œå¿…é¡»å…ˆå¯¹æ™ºèƒ½åˆçº¦è¿›è¡Œä¸¥æ ¼çš„è°ƒè¯•ã€‚

è¿™é‡Œç»™å‡ºä¸€äº›æ™ºèƒ½åˆçº¦å‡ºç°é€»è¾‘æ¼æ´çš„ä¾‹å­ã€‚æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„æ‹å–å¼€å§‹ï¼š

```solidity
pragma solidity ^0.4.21

contract SimpleAuctionV1{
    address public beneficiary;     // æ‹å–å—ç›Šäºº
    uint public auctionEnd;         // ç»“æŸæ—¶é—´
    address public highestBidder;   // å½“å‰çš„æœ€é«˜å‡ºä»·äºº
    mapping(address => unit) bids;  // æ‰€æœ‰ç«æ‹è€…çš„å‡ºä»·
    address[] bidders;              // æ‰€æœ‰ç«æ‹è€…
    bool ended;                     // æ‹å–ç»“æŸåè®¾ä¸º true

    // éœ€è¦è®°å½•çš„äº‹ä»¶
    event HighestBidIncreased(address bidder, unit amount);
    event AuctionEnded(address winner, unit amount);

    // ä»¥å—ç›Šäººåœ°å€ `_beneficiary` çš„åä¹‰ï¼Œ
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„æ‹å–ï¼Œæ‹å–æ—¶é—´ä¸º `_biddingTime` ç§’ã€‚
    // è¿™æ˜¯ä¸€ä¸ªæ‹å–å®ä¾‹çš„æ„é€ å‡½æ•°
    constructor(unit _biddingTime, address _beneficiary) public {
        beneficiary = _beneficiary;
        auctionEnd = now  + _biddingTime;
    }

    // å¯¹æ‹å–å‡ºä»·
    // éšäº¤æ˜“ä¸€èµ·å‘é€çš„ ether ä¸ä¹‹å‰å·²ç»å‘é€çš„ ether çš„å’Œä¸ºæœ¬æ¬¡å‡ºä»·
    function bid() public payable {
        // å¯¹äºèƒ½æ¥æ”¶ ether çš„å‡½æ•°ï¼Œå…³é”®å­— payable æ˜¯å¿…é¡»çš„ã€‚

        // æ‰§è¡Œæ¡ä»¶ï¼šæ‹å–æœªç»“æŸ
        require(now <= auctionEnd);
        // å¦‚æœå‡ºä»·ä¸å¤Ÿé«˜ï¼Œæœ¬æ¬¡å‡ºä»·æ— æ•ˆï¼Œç›´æ¥è¿”å›æŠ¥é”™
        require(bids[msg.sender] + msg.value > bids[highestBidder]);

        // å¦‚æœæ­¤äººä¹‹å‰æœªå‡ºä»·ï¼Œåˆ™åŠ å…¥ç«æ‹è€…åˆ—è¡¨
        if(!bids[msg.sender] == uint(0)) {
            bidder.push(msg.sender);
        }

        // æœ¬æ¬¡å‡ºä»·æ˜¯å½“å‰æœ€é«˜å‡ºä»·ï¼Œæ›´æ–°æœ€é«˜å‡ºä»·
        highestBidder = msg.sender;
        bids[msg.sender] += msg.value;
        emit HighestBidIncreased(msg.sender, bids[msg.sender]);
    }

    // ç»“æŸæ‹å–ï¼ŒæŠŠæœ€é«˜çš„å‡ºä»·å‘é€ç»™å—ç›Šäººï¼Œ 
    // å¹¶æŠŠæœªä¸­æ ‡çš„å‡ºä»·è€…çš„é’±è¿”è¿˜
    function auctionEnd() public {
        // æ‰§è¡Œæ¡ä»¶ï¼Œæ‹å–å·²ç»æˆªæ­¢
        require(now > auctionEnd);
        // æ‰§è¡Œæ¡ä»¶ï¼Œè¯¥å‡½æ•°æœªè¢«è°ƒç”¨è¿‡
        require(!ended);

        // æŠŠæœ€é«˜å‡ºä»·å‘é€ç»™å—ç›Šäºº
        beneficiary.transfer(bid[highestBidder]);
        for (uint i = 0; i < bidders.length; i ++) {
            address bidder = bidder[i];
            if (bidder == highestBidder) continue;
            bidder.transfer(bids[bidder]);
        }
    } 
}
```
è¿™ä¸ªåˆçº¦æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ‰€æœ‰æœªä¸­æ ‡çš„å‡ºä»·è€…çš„é’±è¿”è¿˜éƒ½å†™åœ¨å‡½æ•° `auctionEnd()` ä¸­ã€‚å‡è®¾æŸä¸ªå‡ºä»·è´¦æˆ·æ˜¯ä¸€ä¸ªåˆçº¦è´¦æˆ·ï¼Œæˆ‘ä»¬æåˆ°è¿‡ï¼Œå®ƒä½œä¸º `bidder.transfer(bids[bidder])` çš„æ¥æ”¶è€…å¿…é¡»å®šä¹‰ `fallback()` å‡½æ•°ï¼Œä¸ç„¶ä¼šå‘ç”Ÿå¼‚å¸¸ã€‚
å¦‚æœå°±æœ‰ä¸€ä¸ªè¿™æ ·çš„è´¦æˆ·ï¼Œé‚£ä¹ˆ `auctionEnd()` å‡½æ•°æ‰§è¡Œåˆ°æ­¤å¤„æ—¶ä¼šå°†æ•´ä¸ªå‡½æ•° roll backï¼Œ**æ‰€æœ‰äººçš„é’±éƒ½å–ä¸å‡ºäº†ï¼**
**è€Œä¸”åˆçº¦çš„è§„åˆ™æ˜¯ä¸å¯æ›´æ”¹çš„ï¼Œæˆ‘ä»¬å¯¹æ­¤æ— èƒ½ä¸ºåŠ›ï¼**

æˆ‘ä»¬å°†è¿”è¿˜æœªä¸­æ ‡è€…çš„é’±çš„é€»è¾‘åˆ†ç¦»ï¼Œç”±ç«æ‹è€…è‡ªå·±è°ƒç”¨ç›¸åº”çš„å‡½æ•°ï¼š

```solidity
pragma solidity ^0.4.21

contract SimpleAuctionV2{
  .
  .
  .

  // ä½¿ç”¨ withdraw æ¨¡å¼ï¼Œ
  // ç”±æŠ•æ ‡è€…è‡ªå·±å–å›å‡ºä»·ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ
  function withdraw() public return (bool) {
    // æ‰§è¡Œæ¡ä»¶ï¼šæ‹å–å·²æˆªæ­¢
    require(now > auctionEnd);
    // ç«æ‹æˆåŠŸè€…éœ€è¦æŠŠé’±ç»™å—ç›Šäººï¼Œä¸å¯å–å›å‡ºä»·
    require(msg.sender != highestBidder);
    // éœ€è¦è¿™ä¸ªåœ°å€æœ‰é’±å¯å–
    require(bids[msg.sender] > 0);

    uint amount = bids[msg.sender];
    if (msg.sender.call.value(amount)()) {
        bids[msg.sender] = 0;
        return true;
    }

    return false;
  }

  event Pay2Beneficiary(address winner, uint amount);
  // æ‹å–ç»“æŸï¼ŒæŠŠæœ€é«˜å‡ºä»·å‘é€ç»™å—ç›Šäºº
  function pay2Beneficiary() public return (bool) {
    // æ‰§è¡Œæ¡ä»¶ï¼šæ‹å–å·²æˆªæ­¢
    require(now > auctionEnd);
    // éœ€è¦è¿™ä¸ªåœ°å€æœ‰é’±å¯å–
    require(bids[highestBidder] > 0);

    uint amount = bids[highestBidder];
    bids[highestBidder] = 0;
    emit Pay2Beneficiary(highestBidder, amount);

    if (!beneficiary.call.value(amount)()) {
        bids[highestBidder] = amount;
        return false;
    }

    return true;
  }
}
```

ä½†è¿™ä¸ªä¿®æ”¹åçš„æ–¹æ¡ˆä»ç„¶å­˜åœ¨å·¨å¤§çš„é”™è¯¯ï¼Œå› ä¸ºå®ƒæ— æ³•æŠµæŠ—é‡å…¥æ”»å‡»ï¼ˆRe-entrancy Attackï¼‰ã€‚å½“åˆçº¦è´¦æˆ·æ”¶åˆ° ETH ä½†æœªè°ƒç”¨å‡½æ•°æ—¶ï¼Œä¼šç«‹å³æ‰§è¡Œ `fallback()` å‡½æ•°ï¼Œ`addr.send()` ã€`addr.transfer()`ã€`addr.call.value()()` ä¸‰ç§æ”¯ä»˜æ–¹å¼éƒ½ä¼šå¯¼è‡´æ”¶æ¬¾è´¦æˆ·ä¸Šçš„ `fallback()` å‡½æ•°è¢«è°ƒç”¨ï¼Œè€Œè¿™ä¸ª `fallback()` å‡½æ•°æ˜¯ç”¨æˆ·è‡ªå·±å®šä¹‰çš„ã€‚

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœè¿™ä¸ªç”¨æˆ·åœ¨è‡ªå·±çš„ `fallback()` å‡½æ•°ä¸­å†æ¬¡è°ƒç”¨åˆçº¦çš„ `withdraw()` å‡½æ•°ï¼Œç”±äºæ”¹å˜åˆçº¦è®°å½•çš„è¯­å¥ `bids[msg.sender] = 0;` å†™åœ¨å®é™…æ”¯ä»˜çš„è¯­å¥ `msg.sender.call.value(amount)()` ä¹‹åï¼Œæ‰€ä»¥ `fallback()` å‡½æ•°ä¸­å¯¹ `withdraw()` å‡½æ•°çš„ä»»ä½•ä¸€æ¬¡è°ƒç”¨éƒ½ä¼šé€šè¿‡ `require(bids[msg.sender] > 0);` çš„æ£€æŸ¥ã€‚**æ”¶æ¬¾æ–¹å°†ä¼šä¸æ–­åœ°å—åˆ°æ¥è‡ªåˆçº¦è´¦æˆ·çš„è½¬è´¦ç›´åˆ°å‡½æ•°è°ƒç”¨æ ˆæº¢å‡ºæˆ–åˆçº¦è´¦æˆ·çš„ä½™é¢è¢«è€—å°½ï¼**è¿™ç§æ”»å‡»æ‰‹æ®µå°±æ˜¯ Re-entrancy Attackã€‚

ä¸ºäº†é¿å…è¿™ç±»æ”»å‡»ï¼Œåœ¨ç¼–å†™æ™ºèƒ½åˆçº¦æ—¶æˆ‘ä»¬å¿…é¡»éµå¾ªä¸€ä¸ªåŸåˆ™ï¼Œå³**å†…å­˜ä¸­è®°å½•çš„ä¿®æ”¹å¿…é¡»å‘ç”Ÿåœ¨å®é™…äº¤æ˜“å‰**ï¼š

```solidity
pragma solidity ^0.4.21

contract SimpleAuctionV3{
  .
  .
  .

  // ä½¿ç”¨ withdraw æ¨¡å¼ï¼Œ
  // ç”±æŠ•æ ‡è€…è‡ªå·±å–å›å‡ºä»·ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ
  function withdraw() public return (bool) {
    // æ‰§è¡Œæ¡ä»¶ï¼šæ‹å–å·²æˆªæ­¢
    require(now > auctionEnd);
    // ç«æ‹æˆåŠŸè€…éœ€è¦æŠŠé’±ç»™å—ç›Šäººï¼Œä¸å¯å–å›å‡ºä»·
    require(msg.sender != highestBidder);
    // éœ€è¦è¿™ä¸ªåœ°å€æœ‰é’±å¯å–
    require(bids[msg.sender] > 0);

    uint amount = bids[msg.sender];
    bids[msg.sender] = 0;
    if (msg.sender.call.value(amount)()) {
        return true;
    }

    bids[msg.sender] = amount;
    return false;
  }

  .
  .
  .
}
```

### The DAO äº‹ä»¶
å¯¹ The DAO åˆçº¦çš„ Re-entrancy Attack å¯¼è‡´äº† The DAO çš„åˆçº¦è´¦æˆ·ä¸Šä»·å€¼ 5000 ä¸‡ç¾å…ƒçš„ ETH è½å…¥é»‘å®¢æ‰‹ä¸­ï¼Œå¹¶æœ€ç»ˆä½¿å¾— ETH åˆ†è£‚æˆå¹³è¡Œçš„ ETC ä¸ ETH ä¸¤æ¡é“¾ã€‚å¯¼è‡´ The DAO äº‹ä»¶çš„ä¸»è¦åŸå› æ˜¯æ™ºèƒ½åˆçº¦çš„ç¼–å†™å¤±è¯¯ï¼ŒETH ç»´æŠ¤å›¢é˜Ÿçš„åœ¨äº‹ä»¶åç«‹å³æå‡ºäº†è½¯åˆ†å‰ç­–ç•¥ï¼šæ‰€æœ‰èŠ‚ç‚¹å¢åŠ ä¸€æ¡åˆ¤æ–­é€»è¾‘ï¼Œä¸å…è®¸ä½¿ç”¨å’Œ The DAO ç›¸å…³çš„ ETH è¿›è¡Œäº¤æ˜“ã€‚ä½†ä»–ä»¬å¹¶æ²¡æœ‰ä¸ºè¿™äº›åˆ¤æ–­æŒ‡å®šé¢å¤–çš„ gas feeï¼Œè¿™å¯¼è‡´äº†å¤§é‡çŸ¿å·¥é­é‡äº† DoS æ”»å‡»ï¼Œæœ€å ETH ç»´æŠ¤å›¢é˜Ÿä¸å¾—ä¸é‡‡å–ç¡¬åˆ†å‰ç­–ç•¥ã€‚

wiki é“¾æ¥ï¼š[https://en.wikipedia.org/wiki/The_DAO_(organization)](https://en.wikipedia.org/wiki/The_DAO_(organization))

æŠ€æœ¯åˆ†æï¼š[https://blog.chain.link/reentrancy-attacks-and-the-dao-hack/](https://blog.chain.link/reentrancy-attacks-and-the-dao-hack/)


### Beauty Chain äº‹ä»¶
Beauty Chain äº‹ä»¶æ˜¯ hacker åˆ©ç”¨ç±»å‹æº¢å‡ºå¯¼è‡´çš„è´§å¸è¶…å‘ï¼Œå¯¼è‡´ Beauty Chain çš„ä»£å¸å¸‚å€¼æš´è·Œã€‚

æŠ€æœ¯åˆ†æï¼š[https://learnblockchain.cn/2018/04/25/bec-overflow](https://learnblockchain.cn/2018/04/25/bec-overflow)





